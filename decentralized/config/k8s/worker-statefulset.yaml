apiVersion: v1
kind: Service
metadata:
  name: worker
  labels:
    app: worker
spec:
  type: ClusterIP
  clusterIP: None  # Headless service for StatefulSet
  ports:
    - port: 8000
      targetPort: 8000
      protocol: UDP
      name: worker
  selector:
    app: worker

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: worker
  labels:
    app: worker
spec:
  serviceName: worker
  replicas: 3
  selector:
    matchLabels:
      app: worker
  template:
    metadata:
      labels:
        app: worker
    spec:
      containers:
        - name: worker
          image: sllm/worker:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8000
              protocol: UDP
          env:
            - name: DEPLOYMENT_MODE
              value: "kubernetes"
            - name: LOG_LEVEL
              value: "INFO"
            - name: COORDINATOR_HOST
              value: "central-coordinator"
            - name: COORDINATOR_PORT
              value: "9000"
            - name: WORKER_PORT
              value: "8000"
            - name: REPORT_INTERVAL
              value: "1.0"
            - name: BIND_HOST
              value: "0.0.0.0"
            # WORKER_ID is automatically set from hostname (worker-0, worker-1, etc.)
            - name: WORKER_ID
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            # Model configuration - only opt-1.3b and opt-2.7b supported
            - name: USE_REAL_MODELS
              value: "false"  # Set to "true" to load real PyTorch models
            - name: GCS_BUCKET
              value: "remote_model"
            - name: MODEL_CACHE_DIR
              value: "/tmp/model_cache"
            - name: PYTORCH_DEVICE
              value: "cpu"
            # Memory monitoring configuration
            - name: MEMORY_THRESHOLD
              value: "0.9"
          resources:
            requests:
              memory: "2Gi"  # opt-1.3b needs ~2.6GB
              cpu: "500m"
            limits:
              memory: "6Gi"  # opt-2.7b needs ~5.4GB, with some headroom
              cpu: "2000m"
          livenessProbe:
            exec:
              command:
                - python3
                - -c
                - "import socket; s=socket.socket(socket.AF_INET, socket.SOCK_DGRAM); s.bind(('', 0)); s.close()"
            initialDelaySeconds: 5
            periodSeconds: 10
          readinessProbe:
            exec:
              command:
                - python3
                - -c
                - "import socket; s=socket.socket(socket.AF_INET, socket.SOCK_DGRAM); s.bind(('', 0)); s.close()"
            initialDelaySeconds: 3
            periodSeconds: 5
